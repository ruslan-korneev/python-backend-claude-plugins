# alembic-migrations

Plugin for Alembic migrations with automatic handling of problematic types.

## Philosophy

Alembic autogenerate is not always correct. The plugin automatically:
- Adds enum deletion in downgrade
- Warns about nullable changes without data migration
- Checks the order of FK operations

## Installation

Inside Claude Code, run these slash commands:

```
# Add marketplace
/plugin marketplace add ruslan-korneev/python-backend-claude-plugins

# Install plugin
/plugin install alembic-migrations@python-backend-plugins
```

## Commands

### `/migrate:create <message>`

Creates a migration with automatic problem fixing.

```
/migrate:create add users table
/migrate:create add status enum to orders
```

### `/migrate:check [revision]`

Checks a migration for common problems.

```
/migrate:check          # Latest migration
/migrate:check abc123   # Specific revision
```

## Agent migration-reviewer

Full migration analysis before applying:
- Structure and symmetry
- Enum types and their lifecycle
- Nullable changes
- Foreign keys order
- Potential data loss

## Auto-fixes

### Enum types

```python
# Before (autogenerated)
def downgrade() -> None:
    op.drop_table("orders")
    # Enum is NOT deleted!

# After (fixed)
def downgrade() -> None:
    op.drop_table("orders")
    status_type.drop(op.get_bind(), checkfirst=False)
```

### Nullable changes

```python
# Data migration is automatically added
def upgrade() -> None:
    op.execute("UPDATE users SET name = 'Unknown' WHERE name IS NULL")
    op.alter_column("users", "name", nullable=False)
```

## Structure

```
alembic-migrations/
├── .claude-plugin/
│   └── plugin.json
├── commands/
│   ├── create.md
│   └── check.md
├── agents/
│   └── migration-reviewer.md
├── skills/
│   └── alembic-patterns/
│       ├── SKILL.md
│       └── references/
│           └── enum-handling.md
└── README.md
```

## Links

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 2.0](https://docs.sqlalchemy.org/en/20/)
